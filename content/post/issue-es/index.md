---
title: ES集群的崩溃
description: 一次随意改动生产环境造成的事故
slug: issue-es
date: 2023-03-01 12:00:00+0000
image: cover.png
categories:
    - 问题复盘
tags:
    - Elastic
    - Linux
    - Deploy
---


# 问题复盘
## 责任人
不是我搞炸的，只是负责善后
## 问题表现和原因
**问题表现**：Elasticsearch集群全部掉线，科研大数据赋能平台搜索功能不可用，Kibana页面打不开。

**原因**：原153机器中的Elasticsearch部署方式为压缩包安装，存在机器重启后服务掉线隐患，因此需要重新部署为自启动服务。重新安装后，153机器中的新节点无法接入83机器中的集群，尝试重启83中的主节点后出现ES集群全部不可用的情况，尝试回退机器系统后153机器的原服务不能自动恢复，导致83机器中的集群无法正常工作。

**报错的解决**：ES需要超过半数的集群启动才能启动，否则无法选举出主节点，配置中的init master在已经运行后再启动的集群上不生效。所以减少节点数量最好是逐渐减少。
## 各时间节点（操作和恢复步骤及线上问题表现）
- **2月27号**
尝试在153机器中部署新节点。
- **2月28号**
153机器中的节点无法加入集群
16点尝试重启83机器中的ES服务，Elasticsearch服务掉线，科研大数据赋能平台搜索功能不可用。
17点开始回退机器系统。
- **3月1号**
9点重启153机器中的旧服务。
10点30在153机器中部署新的自启动服务，并成功接入集群，科研大数据赋能平台搜索功能恢复正常。

## 后续避免措施
### ES配置注意事项：
1. 新建节点服务安装完不要启动！不要启动！启动会产生新的cluster uuid，与已有集群不一致，导致无法加入集群。如不慎启动，关闭服务后，删除node文件夹
2. 新节点加入集群只需配置新节点的配置文件即可，证书密钥复制即可，重点配置elasticsearch.yml文件。
## 流程事项：
1. 在不确定是否会对主服务产生影响的情况禁止操作。禁止重启83机器中的服务。
2. 提前规划好操作方案，并整理成技术文档交由主管老师审核，审核通过后执行。